<!DOCTYPE html>
<head>
<title>D3 Output</title>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8">
</script>
<style>
.axis path{
	fill: none;
	stroke: #000000;
	stroke-width:1px;
}
</style>
</head>

<body>
<form>
Search: <input type="text" value="wall" id="query"><br>
<input type="button" value="Submit" onclick="initialsearch(this.form.query.value)">
</form>
	<script>

var debates = ["1","2","3","4","5","6","7","8","9","10","11","12"];

var candidates = ['TRUMP','CRUZ','KASICH','RUBIO','CARSON', 'FIORINA', 'PAUL', 'HUCKABEE', 'WALKER','CHRISTIE', 'BUSH', 'CLINTON', 'SANDERS', 'CHAFEE', 'WEBB'];

var stack = d3.layout.stack().offset("silhouette")
		.values(function(d) { return d.values; })
		.x(function(d) { return +d.debate;})
		.y(function(d) { return d.count;});

var nest = d3.nest()
	.key(function (d) {return d.sentiment})

var color = d3.scale.ordinal()
	.domain(["negative","somewhat negative","neutral","somewhat positive","positive"])
	.range(["#d62728","#ff9896","#ffbb78","#98df8a","#2ca02c"]);

var margin = {top: 5, right: 20, bottom: 20, left: 40},
    width = 960 - margin.left - margin.right,
    height = 90 - margin.top - margin.bottom;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(3);

var area = d3.svg.area()
		.interpolate("monotone")
    .x(function(d) { return x(+d.debate); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var sortable = {
	"positive" : 1,
	"somewhat positive": 2,
	"neutral": 3,
	"somewhat negative": 4,
	"negative": 5
};


function initialsearch(search_string){
	d3.selectAll("svg").remove();
	d3.selectAll("p").remove();
	d3.json("results?search_query=" + search_string, function(error, data) {
		if (error){
			console.log(error);
			data = [];
		}else{
			data = data.debate_data;
		}
		//console.log(data);

		var rollup = d3.nest()
			.key(function(d){return d.candidate;})
			.key(function(d){return d.debate;})
			.rollup(function(d){return d3.sum(d, function(g){return g.count;})})
			.entries(data);

		var ymax = d3.max(rollup, function(d) { return d3.max(d.values, function(g) {return g.values;})});
		// console.log(ymax);
		// console.log(rollup);
		candidates.forEach(function (candidate){
			d3.select("body").append("p")
				.text(candidate);

			var svg = d3.select("body").append("svg")
			    .attr("width", width + margin.left + margin.right)
			    .attr("height", height + margin.top + margin.bottom)
					.attr("id", candidate)
			  .append("g")
			    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


			var candidate_data = data.filter(function(d) {return d.candidate==candidate});
			candidate_data = nest.entries(candidate_data);
			console.log(candidate_data)
			candidate_data.forEach(function (d){
				debates.forEach(function (f){
					if (!d.values.some(function (g){
						return g.debate === f;
					})){
						d.values.push({"debate":f,"count":0});
					}
				})
				//d.values.sort(function(a,b){return +a.debate - +b.debate;});
				d.values.sort(function(a,b){return +a.debate - +b.debate;});
			});
			candidate_data.sort(function(a,b){return sortable[b.key] - sortable[a.key];});
			candidate_data = stack(candidate_data);

			var candidate_max = d3.max(candidate_data, function(d) { return d3.max(d.values, function(g) {return g.y0 + g.y;})});
			x.domain([1,d3.max(debates, function(d) { return +d; })]);
			y.domain([-ymax/2,ymax/2]);

		  svg.append("g")
		      .attr("class", "x axis")
		      .attr("transform", "translate(0," + height + ")")
		      .call(xAxis);

		  svg.append("g")
		      .attr("class", "y axis")
		      .call(yAxis)

			svg.selectAll(".layer")
					.data(candidate_data)
				.enter().append("path")
					.attr("d", function(d) {return area(d.values)})
					.attr("fill", function(d) {return color(d.key)})
					.attr("transform", "translate(0," + candidate_max/2 * height/ymax + ")")
					.attr("class", function(d) {return d.key;});

		});

	} );
}

function updatesearch(search_string){
	d3.json("results?search_query=" + search_string, function(error, data) {
		if (error){
			console.log(error);
			data = [];
		}else{
			data = data.debate_data;
		}
		console.log(data);

		var rollup = d3.nest()
			.key(function(d){return d.candidate;})
			.key(function(d){return d.debate;})
			.rollup(function(d){return d3.sum(d, function(g){return g.count;})})
			.entries(data);

		var ymax = d3.max(rollup, function(d) { return d3.max(d.values, function(g) {return g.values;})});

		candidates.forEach(function (candidate){

			var svg = d3.select("#" + candidate);


			var candidate_data = data.filter(function(d) {return d.candidate==candidate});
			candidate_data = nest.entries(candidate_data);

			candidate_data.forEach(function (d){
				debates.forEach(function (f){
					if (!d.values.some(function (g){
						return g.debate === f;
					})){
						d.values.push({"debate":f,"count":0});
					}
				})
				d.values.sort(function(a,b){return +a.debate - +b.debate;});
			});
			candidate_data.sort(function(a,b){return sortable[b.key] - sortable[a.key];});
			candidate_data = stack(candidate_data);

			var candidate_max = d3.max(candidate_data, function(d) { return d3.max(d.values, function(g) {return g.y0 + g.y;})});
			x.domain([1,d3.max(debates, function(d) { return +d; })]);
			y.domain([-ymax/2,ymax/2]);

			var layers = svg.selectAll(".layer");

			svg.selectAll(".layer")
					.data(candidate_data)
				.enter().append("path")
					.transistion(2500)
					.attr("d", function(d) {return area(d.values)})
					.attr("fill", function(d) {return color(d.key)})
					.attr("transform", "translate(0," + candidate_max/2 * height/ymax + ")");

		});

	} );
}

initialsearch("wall");
</script>
</body>
